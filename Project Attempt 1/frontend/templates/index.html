<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="enterprise-tabs-container">
        <div class="enterprise-tabs-header">
            <div class="enterprise-title">Data Opportunity Portal</div>
            <div class="enterprise-tabs">
                <button class="tab-btn active" data-tab="submit">Submit Opportunity</button>
                <button class="tab-btn" data-tab="view">View All Opportunity</button>
            </div>
        </div>
        <div class="enterprise-tabs-content">
            <section id="tab-submit" class="tab-section active">
                <h2 class="section-title">Submit a New Data Opportunity</h2>
                <form class="opportunity-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Opportunity Title</label>
                            <input type="text" id="title" name="title" placeholder="e.g. Customer Churn Prediction" required>
                        </div>
                        <div class="form-group">
                            <label for="client">Client Organization</label>
                            <input type="text" id="client" name="client" placeholder="e.g. Acme Corp" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contact_name">Contact Name</label>
                            <input type="text" id="contact_name" name="contact_name" placeholder="e.g. John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="contact_email">Contact Email</label>
                            <input type="email" id="contact_email" name="contact_email" placeholder="e.g. john.doe@email.com" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Type of Data Solution</label>
                            <select id="type" name="type" required>
                                <option value="" disabled selected>Select type</option>
                                <option>Analytics</option>
                                <option>Data Engineering</option>
                                <option>AI/ML</option>
                                <option>Consulting</option>
                                <option>Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="complexity">Estimated Complexity</label>
                            <input type="text" id="complexity" name="complexity" placeholder="e.g. Medium, High, Low" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="width:100%;">
                            <label for="description">Work Description</label>
                            <textarea id="description" name="description" placeholder="Describe the opportunity..." required style="min-height:80px;width:100%;"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="duration">Expected Duration</label>
                            <input type="text" id="duration" name="duration" placeholder="e.g. 3 months" required>
                        </div>
                        <div class="form-group">
                            <label for="skills">Key Skill Sets Required</label>
                            <input type="text" id="skills" name="skills" placeholder="e.g. Python, SQL, ML, Data Engineering" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deal_value">Estimated Deal Value (USD)</label>
                            <input type="number" id="deal_value" name="deal_value" placeholder="e.g. 50000" min="0" step="any" required>
                        </div>
                        <div class="form-group" style="flex:1;display:flex;align-items:flex-end;">
                            <button type="submit" class="submit-btn" style="width:100%;">Submit Opportunity</button>
                        </div>
                    </div>
                </form>
                <div id="response-message" style="margin-top:1.2em;"></div>
                        </section>

                        <section id="tab-view" class="tab-section" style="display:none;">
                            <h2 class="section-title">All Opportunities</h2>
                            <button id="load-opps-btn" class="load-btn">Load Data</button>
                            <div id="opps-table-scroll" style="max-width:100%;overflow:auto;margin-top:1.2em;">
                                <div id="opps-table-container"></div>
                            </div>
            </section>

        </div>
    </div>

    <script>
    // Tab switching logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.tab-section').forEach(sec => sec.style.display = 'none');
            const tab = this.getAttribute('data-tab');
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).style.display = '';
        });
    });

    // Load opportunities logic (should be outside form submit handler)
    document.getElementById('load-opps-btn').addEventListener('click', async function() {
        const container = document.getElementById('opps-table-container');
        container.innerHTML = 'Loading...';
        try {
            const res = await fetch('http://127.0.0.1:8001/view_opportunity');
            const html = await res.text();
            if (res.ok) {
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div style='color:red;'><b>Error:</b> Could not load data.</div>`;
            }
        } catch (err) {
            container.innerHTML = `<div style='color:red;'><b>Network error:</b> ${err}</div>`;
        }
    });
    // Only form submission logic remains
    document.querySelector('.opportunity-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            title: form.title.value,
            client: form.client.value,
            contact_name: form.contact_name.value,
            contact_email: form.contact_email.value,
            description: form.description.value,
            type: form.type.value,
            complexity: form.complexity.value,
            duration: form.duration.value,
            skills: form.skills.value,
            deal_value: parseFloat(form.deal_value.value)
        };
        try {
            const res = await fetch('http://127.0.0.1:8001/opportunity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                // Try to extract insights fields if raw is present
                let insights = result.insights;
                if (insights && insights.raw) {
                    // Try to extract JSON from raw string
                    const match = insights.raw.match(/```json([\s\S]*?)```/);
                    if (match) {
                        try {
                            insights = JSON.parse(match[1]);
                        } catch {}
                    }
                }
                let tiles = '';
                if (insights) {
                    if (insights.top_performing_lead_sources) {
                        tiles += `<div class='insight-tile'><h3>Top Performing Lead Sources</h3><p>${insights.top_performing_lead_sources}</p></div>`;
                    }
                    if (insights.conversion_patterns) {
                        tiles += `<div class='insight-tile'><h3>Conversion Patterns</h3><p>${insights.conversion_patterns}</p></div>`;
                    }
                    if (insights.recommendations) {
                        tiles += `<div class='insight-tile'><h3>Recommendations</h3><p>${insights.recommendations}</p></div>`;
                    }
                }
                document.getElementById('response-message').innerHTML = `<div style='color:green;'><b>Opportunity submitted successfully!</b><br><div class='insight-tiles'>${tiles}</div></div>`;
                form.reset();
            } else {
                document.getElementById('response-message').innerHTML = `<div style='color:red;'><b>Error:</b> ${result.detail || 'Unknown error'}</div>`;
            }
        } catch (err) {
            document.getElementById('response-message').innerHTML = `<div style='color:red;'><b>Network error:</b> ${err}</div>`;
        }
    });
    </script>
</body>
</html>
